<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glaucoma Detection</title>
    <link rel="stylesheet" href="../static/css/gStyle.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="nav-container">
            <a class="nav-logo">Optitech Eye</a>
            <button class="hamburger">☰</button>
            <div class="nav-menu">
                <a href="/exercise_full">Eye-Exercise</a>
                <a href="/cataract">Cataract</a>
                <a href="/glaucomaPage" class="active">Glaucoma-Test</a>
                <a href="/eye_fatigue">Eye Fatigue</a>
                <a href="/color_test">Color Blindness Test</a>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <header class="glaucoma-header">
        <div class="glaucoma-header-content">
            <h1>Glaucoma Detection System</h1>
            <p>Assess your risk of glaucoma with our advanced detection tools.</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="glaucoma-main-container">
        <!-- Questionnaire Section -->
        <div class="glaucoma-section">
            <h2>Risk Assessment Form</h2>
            <p class="glaucoma-info-text">Please fill out the questionnaire to enable detection methods.</p>
            <form id="questionnaire-form">
                <div class="glaucoma-form-group">
                    <label for="age">Age:</label>
                    <input type="number" id="age" name="age" required min="0" max="120" placeholder="Enter your age (e.g., 45)">
                </div>
                <div class="glaucoma-form-group">
                    <label for="family_history">Family History of Glaucoma:</label>
                    <select name="family_history" id="family_history" required>
                        <option value="">Check all that apply</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="glaucoma-form-group">
                    <label>Symptoms:</label>
                    <div class="glaucoma-checkbox-group">
                        <label><input type="checkbox" name="symptoms" value="Blurred Vision"> Blurred Vision</label>
                        <label><input type="checkbox" name="symptoms" value="Eye Pain"> Eye Pain</label>
                        <label><input type="checkbox" name="symptoms" value="Halos"> Halos</label>
                    </div>
                </div>
                <div class="glaucoma-form-group">
                    <label for="iop_history">Intraocular Pressure (if known):</label>
                    <input type="number" step="0.1" id="iop_history" name="iop_history" min="0" placeholder="Enter pressure in mmHg (e.g., 21.5)">
                </div>
                <div class="glaucoma-form-group">
                    <label for="medical_history">Other Medical History:</label>
                    <textarea name="medical_history" id="medical_history" rows="3" maxlength="500" placeholder="Describe any relevant conditions (e.g., diabetes, hypertension)"></textarea>
                </div>
                <button type="submit" class="glaucoma-btn glaucoma-btn-submit">Submit</button>
            </form>
        </div>

        <!-- Method Selection -->
        <div class="glaucoma-section glaucoma-hidden" id="method-section">
            <h2>Select Detection Method</h2>
            <div class="glaucoma-method-selection">
                <label><input type="radio" name="method" value="realtime"> Real-Time Webcam</label>
                <label><input type="radio" name="method" value="upload"> Upload Video</label>
            </div>
        </div>

        <!-- Detection Controls -->
        <div class="glaucoma-section glaucoma-hidden" id="control-section">
            <div class="glaucoma-button-group">
                <button id="start-btn" class="glaucoma-btn glaucoma-btn-start glaucoma-hidden">Start Detection</button>
                <div class="glaucoma-hidden" id="upload-group">
                    <input type="file" id="video-file" accept="video/*" class="glaucoma-file-input">
                    <button id="upload-btn" class="glaucoma-btn glaucoma-btn-analyze">Analyze Video</button>
                </div>
                <button id="stop-btn" class="glaucoma-btn glaucoma-btn-end glaucoma-hidden">Stop</button>
                <button id="reset-btn" class="glaucoma-btn glaucoma-btn-reset" onclick="location.reload()">Reset</button>
            </div>
            <p id="recording-message" class="glaucoma-info-text glaucoma-hidden">Recording 10 seconds of webcam footage...</p>
            <p id="analyzing-message" class="glaucoma-info-text glaucoma-hidden">Analyzing recorded footage...</p>
        </div>

        <!-- Video Feed -->
        <div class="glaucoma-section glaucoma-hidden" id="video-section">
            <h2>Video Feed</h2>
            <img id="video-feed" class="glaucoma-video-feed glaucoma-hidden" src="" alt="Video Feed">
        </div>

        <!-- Results -->
        <div class="glaucoma-section glaucoma-hidden" id="results">
            <h2>Prediction</h2>
            <p><strong>Glaucoma Probability:</strong> <span id="glaucoma-prob">N/A</span>%</p>
            <p><strong>Healthy Probability:</strong> <span id="healthy-prob">N/A</span>%</p>
            <p><strong>Pupil Radius:</strong> <span id="pupil-radius">N/A</span> px</p>
            <p><strong>Pupil Area:</strong> <span id="pupil-area">N/A</span> px²</p>
            <p><strong>Circularity:</strong> <span id="pupil-circularity">N/A</span></p>
            <button id="compare-btn" class="glaucoma-btn glaucoma-btn-submit" disabled>Compare and Predict</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        © 2025 Optitech Eye Program | Powered by Alphacode
    </footer>

    <script>
        // Toggle hamburger menu on mobile
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');

        hamburger.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            hamburger.textContent = navMenu.classList.contains('active') ? '✕' : '☰';
        });

        navMenu.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                navMenu.classList.remove('active');
                hamburger.textContent = '☰';
            });
        });

        const form = document.getElementById("questionnaire-form");
        const methodSection = document.getElementById("method-section");
        const controlSection = document.getElementById("control-section");
        const startBtn = document.getElementById("start-btn");
        const uploadGroup = document.getElementById("upload-group");
        const uploadBtn = document.getElementById("upload-btn");
        const videoFile = document.getElementById("video-file");
        const videoSection = document.getElementById("video-section");
        const videoElement = document.getElementById("video-feed");
        const results = document.getElementById("results");
        const stopBtn = document.getElementById("stop-btn");
        const compareBtn = document.getElementById("compare-btn");
        const glaucomaProb = document.getElementById("glaucoma-prob");
        const healthyProb = document.getElementById("healthy-prob");
        const pupilRadius = document.getElementById("pupil-radius");
        const pupilArea = document.getElementById("pupil-area");
        const pupilCircularity = document.getElementById("pupil-circularity");
        const recordingMessage = document.getElementById("recording-message");
        const analyzingMessage = document.getElementById("analyzing-message");

        let selectedMethod = null;
        let recordingTimeout = null;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const age = parseInt(document.getElementById("age").value);
            const familyHistory = document.getElementById("family_history").value;
            const iopHistory = document.getElementById("iop_history").value;
            const medicalHistory = document.getElementById("medical_history").value;

            let errors = [];
            if (!age || age < 0 || age > 120) errors.push("Age must be between 0 and 120.");
            if (!familyHistory) errors.push("Please select a family history option.");
            if (iopHistory && parseFloat(iopHistory) < 0) errors.push("Intraocular pressure must be non-negative.");
            if (medicalHistory && medicalHistory.length > 500) errors.push("Medical history must not exceed 500 characters.");

            if (errors.length > 0) {
                alert("Please fix the following errors:\n- " + errors.join("\n- "));
                return;
            }

            let qScore = 0;
            qScore += 0.02 * Math.max(0, age - 40);
            if (familyHistory === "Yes") qScore += 0.3;
            const symptoms = Array.from(form.querySelectorAll("input[name='symptoms']:checked")).length;
            qScore += 0.1 * symptoms;
            const iop = parseFloat(iopHistory) || 0;
            if (iop > 30) qScore += 0.4;
            else if (iop > 21) qScore += 0.2;

            const formData = new FormData(form);
            formData.set("symptoms", symptoms ? Array.from(form.querySelectorAll("input[name='symptoms']:checked")).map(i => i.value).join(', ') : "None");
            formData.append("questionnaire_score", qScore.toFixed(3));

            const res = await fetch("/submit_questionnaire", { method: "POST", body: formData });
            const data = await res.json();
            if (data.status === "questionnaire submitted") {
                methodSection.classList.remove("glaucoma-hidden");
            }
        });

        methodSection.addEventListener("change", e => {
            selectedMethod = e.target.value;
            controlSection.classList.remove("glaucoma-hidden");
            startBtn.classList.toggle("glaucoma-hidden", selectedMethod !== "realtime");
            uploadGroup.classList.toggle("glaucoma-hidden", selectedMethod !== "upload");
            compareBtn.disabled = true;
            compareBtn.classList.add("glaucoma-btn-disabled");
        });

        startBtn.addEventListener("click", () => {
            alert("Keep distance 5-10 inches with camera and eye!");
            videoElement.src = "/video_feed?type=webcam";
            videoElement.classList.remove("glaucoma-hidden");
            videoSection.classList.remove("glaucoma-hidden");
            stopBtn.classList.remove("glaucoma-hidden");
            startBtn.classList.add("glaucoma-hidden");
            results.classList.remove("glaucoma-hidden");
            recordingMessage.classList.remove("glaucoma-hidden");
            compareBtn.disabled = true;
            compareBtn.classList.add("glaucoma-btn-disabled");
            recordingTimeout = setTimeout(async () => {
                recordingMessage.classList.add("glaucoma-hidden");
                analyzingMessage.classList.remove("glaucoma-hidden");
                const res = await fetch("/compare_predict");
                const data = await res.json();
                analyzingMessage.classList.add("glaucoma-hidden");
                console.log("Auto-predict response:", data);
                if (data.error) {
                    alert(data.error);
                    return;
                }
                glaucomaProb.textContent = data.glaucoma_prob;
                healthyProb.textContent = data.healthy_prob;
                compareBtn.classList.add("glaucoma-btn-disabled");
                compareBtn.disabled = true;
            }, 10000);
        });

        uploadBtn.addEventListener("click", async () => {
            const file = videoFile.files[0];
            if (!file) return alert("Please select a video file.");

            const formData = new FormData();
            formData.append("video", file);

            await fetch("/analyze_video", { method: "POST", body: formData });

            videoElement.src = "/video_feed?type=uploaded";
            videoElement.classList.remove("glaucoma-hidden");
            videoSection.classList.remove("glaucoma-hidden");
            stopBtn.classList.remove("glaucoma-hidden");
            uploadGroup.classList.add("glaucoma-hidden");
            results.classList.remove("glaucoma-hidden");
            compareBtn.disabled = false;
            compareBtn.classList.remove("glaucoma-btn-disabled");
        });

        stopBtn.addEventListener("click", async () => {
            const res = await fetch("/stop_feed", { method: "POST" });
            const data = await res.json();
            console.log("Stop feed response:", data);
            videoElement.src = "";
            videoElement.classList.add("glaucoma-hidden");
            videoSection.classList.add("glaucoma-hidden");
            stopBtn.classList.add("glaucoma-hidden");
            startBtn.classList.toggle("glaucoma-hidden", selectedMethod !== "realtime");
            uploadGroup.classList.toggle("glaucoma-hidden", selectedMethod !== "upload");
            recordingMessage.classList.add("glaucoma-hidden");
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            if (data.has_data) {
                compareBtn.disabled = false;
                compareBtn.classList.remove("glaucoma-btn-disabled");
            } else {
                alert("No data available for prediction.");
            }
        });

        compareBtn.addEventListener("click", async () => {
            if (!videoElement.src || videoElement.classList.contains("glaucoma-hidden")) {
                alert("Please start detection to get a prediction.");
                return;
            }
            analyzingMessage.classList.remove("glaucoma-hidden");
            const res = await fetch("/compare_predict");
            const data = await res.json();
            analyzingMessage.classList.add("glaucoma-hidden");
            console.log("Manual predict response:", data);
            if (data.error) {
                alert(data.error);
                return;
            }
            glaucomaProb.textContent = data.glaucoma_prob;
            healthyProb.textContent = data.healthy_prob;
            compareBtn.classList.add("glaucoma-btn-disabled");
            compareBtn.disabled = true;
        });

        setInterval(async () => {
            const res = await fetch("/pupil_dynamics");
            const data = await res.json();
            pupilRadius.textContent = data.pupil_radius || 'N/A';
            pupilArea.textContent = data.pupil_area || 'N/A';
            pupilCircularity.textContent = data.pupil_circularity || 'N/A';
        }, 2000);
    </script>
</body>
</html>